docker run -it --rm --volume "$(pwd):/ansible" --workdir /ansible ansible

curl https://packages.microsoft.com/config/rhel/7/prod.repo | tee /etc/yum.repos.d/microsoft.repo
yum install -y powershell
pwsh
Install-Module -Name Az

Connect-AzAccount -tenant cc8ce3ac-15ea-4a06-9376-26d18f587bfa
Import-Module Az

$password = '8%Uv%+nZx&mKn6Ps'
$credentials = New-Object Microsoft.Azure.Commands.ActiveDirectory.PSADPasswordCredential -Property @{
StartDate=Get-Date; EndDate=Get-Date -Year 2024; Password=$password};
$spSplat = @{
  DisplayName = 'ansible'
  PasswordCredential = $credentials
}
$sp = New-AzAdServicePrincipal @spSplat


$subId = (Get-AzContext).Subscription.Id
$roleAssignmentSplat = @{
  ObjectId = $sp.id;
  RoleDefinitionName = 'Contributor';
  Scope = "/subscriptions/$subId"
}
New-AzRoleAssignment @roleAssignmentSplat


                  RoleAssignmentId   : /subscriptions/4c55038b-f4e5-4dae-9223-f9d6b33f15a2/providers/Microsoft.Authorization/roleAssignments/0b872099-941f-4bfb-a4c5-f38e5270d76c
                Scope              : /subscriptions/4c55038b-f4e5-4dae-9223-f9d6b33f15a2
                DisplayName        : ansible
                SignInName         :
                RoleDefinitionName : Contributor
                RoleDefinitionId   : b24988ac-6180-42a0-ab88-20f7382dd24c
                ObjectId           : 9e27255d-b351-447b-a44f-9ac359fe315b
                ObjectType         : ServicePrincipal
                CanDelegate        : False
                Description        :
                ConditionVersion   :
                Condition          :

exit

subscriptionId=$(pwsh -c "(Get-AzContext).Subscription.Id")
clientid=$(pwsh -c "(Get-AzADServicePrincipal -DisplayName 'ansible').ApplicationId.Guid")
secret='8%Uv%+nZx&mKn6Ps'
tenantid=$(pwsh -c "(Get-AzContext).Tenant.Id")
export AZURE_SUBSCRIPTION_ID=$subscriptionId;
export AZURE_CLIENT_ID=$clientid;
export AZURE_SECRET=$secret;
export AZURE_TENANT=$tenantid;


ansible localhost -m azure_rm_resourcegroup -a "name=ansible location=westuk"

change to chapter-03/azure folder




start container:
 docker run -it --rm --volume "$(pwd):/azure"  -e "AZURE_SUBSCRIPTION_ID=4c55038b-f4e5-4dae-9223-f9d6b33f15a2" -e "AZURE_CLIENT_ID=44fae583-b941-4ac3-bb1c-906999e8ab47" -e "AZURE_SECRET=8%Uv%+nZx&mKn6Ps" -e "AZURE_TENANT=cc8ce3ac-15ea-4a06-9376-26d18f587bfa" ansible



